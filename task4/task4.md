# Архитектурное решение для системы логирования

## 1. Структура логирования

### 1.1 Обязательные атрибуты логов
| Атрибут | Описание | Источник |
|---------|----------|----------|
| trace_id, span_id | Связь с трейсингом | Runtime |
| request_id, thread_id | Идентификация запроса | Runtime |
| user_id | Идентификатор пользователя | Контекст |
| method_name, method_params | Вызываемый метод и параметры | Runtime |
| order_id | ID заказа (где применимо) | Бизнес-контекст |
| datetime | Временная метка | Система |

### 1.2 События для логирования (INFO)
**Shop API:**
- Создание заказа: order_id, user_id, datetime

**MES API:**
- Расчёт цены: order_id, user_id, price, datetime
- Передача в работу: order_id, employee_id, datetime
- Выполнение/упаковка/отправка заказа

**CRM API:**
- Закрытие заказа: order_id, employee_id, datetime
- Смена статуса заказа

### 1.3 Уровни логирования
- **INFO**: Бизнес-события (создание заказа, авторизация, смена статуса)
- **WARN**: Неуспешные авторизации, некритические ошибки валидации
- **ERROR**: Ошибки создания заказа, загрузки файлов (+ stack trace)
- **DEBUG**: В тестовых средах для детальной отладки

## 2. Мотивация и приоритеты

### 2.1 Преимущества
- Уменьшение времени поиска проблем по жалобам
- Источник данных для мониторинга и аналитики
- Точное понимание параметров при исполнении методов

### 2.2 Влияние на метрики
**Технические:**
- Количество запросов/ответов через API
- Среднее время отработки запросов
- Количество ошибок в единицу времени

**Бизнес:**
- Количество клиентов и заказов
- Количество повторных заказов
- Глубина просмотра сайта

### 2.3 Приоритеты внедрения
1. **Первая очередь**: Shop API, MES API - работа с пользователями (потери клиентов критичны)
2. **Вторая очередь**: CRM API, Messages Queue
3. **По возможности**: Все остальные компоненты

## 3. Технологическое решение

### 3.1 Стек технологий
- **Основной вариант**: Grafana Stack (Grafana + Loki + Promtail) - унификация с мониторингом
- **Альтернативы**: Graylog, Fluentd, LOGalyze

### 3.2 Политика безопасности
- **Маскирование**: специальные объекты с переопределенным toString() для чувствительных данных
- **Доступ**: 
  - Полный доступ - команда разработки
  - Ограниченный доступ к дашбордам - техподдержка
  - Интеграция с корпоративной системой аутентификации (LDAP)

### 3.3 Политика хранения
| Тип логов | Срок хранения | Обоснование |
|-----------|---------------|-------------|
| DEBUG | До 1 недели | Краткосрочная отладка |
| WARN/ERROR | До 3 месяцев | Должны переводиться в задачи |
| INFO | 1-2 квартала | Бизнес-аналитика |
| Общая ротация | 2 месяца | Стандартная рециркуляция |

## 4. Система анализа и алертинга

### 4.1 Алерты
- Ошибки сервиса чаще 1 раза в час
- Ошибки для критичных методов
- Резкое увеличение RPS (возможная DDoS атака)
- Отсутствие логов сервиса более 1 часа

### 4.2 Детекция аномалий
- thread_id + request_id не изменяется более 1 часа (зависание)
- Взрывное увеличение трафика (10000 заказов вместо 4)
- Подборы паролей и попытки взлома
- Пиковые нагрузки на СУБД

### 4.3 Визуализация
- Дашборды с визуализацией логов по сервисам
- Метрики по проценту ошибок
- Мониторинг времени отклика систем
- Глубина и время нахождения клиентов в магазине

**Индексация**: Разбивка по сервисам + 2-недельная давность для быстрого поиска