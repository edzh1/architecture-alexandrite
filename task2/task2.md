# Архитектурное решение для системы мониторинга

## 1. Мотивация внедрения мониторинга

### 1.1 Технические преимущества
- **Улучшение видимости и повышение безопасности системы** - получение полного представления о работе системы
- **Более быстрое решение проблем** - инструменты наблюдения помогают быстрее определить корень проблемы
- **Повышение быстродействия системы** - выявление узких мест для оптимизации производительности
- **Снижение времени реакции на инциденты** - например, при потере заказов или задержках MES

### 1.2 Бизнес-преимущества
- **Защита от перегрузок B2B API** - контроль сторонних интеграционных команд (перегрузка, дублирование, ошибочные запросы)
- **Бизнес-метрики** - конверсия клиентов, сроки жизни заказа, сроки обслуживания клиента по отделам
- **Ценные бизнес-инсайты** - накопленные данные помогут принимать стратегические решения
- **Повышение удовлетворённости пользователей** - своевременное решение проблем с производительностью
- **Оценка SLA** - отслеживание заказов, обрабатываемых с опозданием

## 2. Выбор подходов к мониторингу

### 2.1 USE метод
**Применение:** На первоначальном этапе для выявления проблемных сервисов
- **Utilization** - среднее время занятости ресурса (в процентах)
- **Saturation** - объём работы в очереди
- **Errors** - количество ошибок

**Где применяется:**
- Очереди RabbitMQ
- Внутренние процессы

### 2.2 RED метод
**Применение:** Для API сервисов и дальнейшего тюнинга системы
- **Rate** - частота запросов (RPS)
- **Errors** - количество неудачных запросов (HTTP 5xx)
- **Duration** - время выполнения запроса (latency)

**Где применяется:**
- Shop API
- CRM API  
- MES API
- Базы данных

### 2.3 Четыре золотых сигнала (LETS/STELA)
**Применение:** Для пользовательских интерфейсов
- **Latency** - особенно важен для MES UI
- **Traffic**
- **Errors**
- **Saturation**

**Где применяется:**
- MES UI Dashboard
- API Gateway

## 3. Метрики для отслеживания

### 3.1 API метрики

| Метрика | Описание | Лейблы | Цель |
|---------|----------|--------|------|
| Number of requests (RPS) | Общий поток в системы | service, endpoint, user_type | Понимание нагрузки |
| Number of requests per user | Лимиты на использование API | service, endpoint, user_type | Контроль B2B партнеров |
| Response time (latency) | Время ответа API | service, endpoint | Выявление узких мест |
| Number of HTTP 500 | Количество ошибок | service, code | Процент ошибок |
| Availability | Доступность сервисов | service | Мониторинг падений |
| CPU % | Загрузка процессора | service | Насыщенность сервисов |
| Memory Utilisation | Использование памяти | service | Оптимизация конфигов |

### 3.2 Метрики баз данных

| Метрика | Описание | Лейблы | Цель |
|---------|----------|--------|------|
| Number of connections | Входящие подключения | db_name, role | Оценка нагрузки |
| Memory Utilisation | Использование памяти | db_name | Проверка индексов и конфигов |
| db_size | Размер БД | db_name | Планирование масштабирования |

### 3.3 Метрики очередей RabbitMQ

| Метрика | Описание | Лейблы | Цель |
|---------|----------|--------|------|
| messages_in_flight | Необработанные сообщения | queue, routing_key | Мониторинг роста очередей |
| dead_letter_count | Отброшенные сообщения | queue | Выявление потери заказов |

### 3.4 Метрики MES UI

| Метрика | Описание | Лейблы | Цель |
|---------|----------|--------|------|
| mes_ui_latency_dashboard_load | Время загрузки дашборда | page, user_role | Влияние на работу операторов |
| orders_count_by_status | Количество заказов по статусам | status | Насыщенность MES |
| Kb transferred/provided | Объемы данных | - | Оценка расширения системы |

### 3.5 Бизнес-метрики
- Количество и динамика пользователей магазина
- Количество заказов (общее/в работе/выполненных в срок)
- Время исполнения заказа
- Время ожидания заказа до взятия в работу
- Количество заказов на оператора/продавца

## 4. Пороговые значения и алерты

| Метрика | Порог | Действие |
|---------|-------|----------|
| http_latency > 2s | > 10% запросов | Алерт DevOps, тикет |
| messages_in_flight > 1000 | > 2 мин | Добавить воркеров |
| dead_letter_count > 0 | мгновенно | Срочный тикет |
| CPU > 80% | > 5 мин | Масштабировать инстанс |
| mes_ui_latency > 3s | > 10% загрузок | Оптимизация, кеширование |
| HTTP 500 > 1% | - | Алерт |

## 5. План действий по внедрению

### 5.1 Инфраструктура мониторинга
1. **Развернуть стек мониторинга**
   - Time-series база данных (Victoria Metrics/Prometheus)
   - Grafana для визуализации
   - Протестировать инфраструктуру

2. **Настроить сбор метрик**
   - Установить экспортеры: node_exporter, rabbitmq_exporter, postgres_exporter, s3_exporter
   - Для .NET использовать OpenTelemetry SDK + exporter
   - Настроить health checks и актуаторы для Prometheus

### 5.2 Интеграция с приложениями
3. **Spring Boot сервисы**
   - Подключить spring зависимость для Prometheus
   - Скачать и настроить JSON дашборды

4. **C# сервисы**
   - Повторить настройку для .NET приложений
   - Интегрировать с OpenTelemetry

### 5.3 Мониторинг и алертинг
5. **Создать дашборды**
   - API health (Shop, CRM, MES)
   - RabbitMQ queues
   - MES UI performance
   - Бизнес-метрики

6. **Настроить алерты в Grafana**
   - Интеграция с Slack/Telegram/email
   - Автоматическое создание тикетов при критических событиях

7. **Внедрить систему BI анализа**
   - Анализ показателей в динамике
   - Формирование отчетов для бизнеса

## 6. Ожидаемые результаты

- **Немедленная видимость** проблемных мест системы через метрики
- **Снижение MTTR** (Mean Time To Repair) благодаря быстрой диагностике
- **Проактивное масштабирование** на основе трендов нагрузки
- **Контроль SLA** и качества обслуживания
- **Защита от перегрузок** со стороны B2B партнеров
- **Бизнес-инсайты** для принятия стратегических решений