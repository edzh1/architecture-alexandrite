# Архитектурное решение для системы трейсинга

## 1. Анализ и области покрытия

### 1.1 Системы для трейсинга
**Критические компоненты:**
- **Shop API** - создание заказа, загрузка 3D модели
- **CRM API** - подтверждение заказа, перевод статуса  
- **MES API** - расчёт стоимости (может занимать до 30 минут), начало/завершение производства
- **RabbitMQ** - потенциальная потеря сообщений
- **3D files storage** - возможна потеря файлов

### 1.2 Данные для трейсинга
| Поле | Описание | Цель |
|------|----------|------|
| trace_id | Единый ID во всех системах | Сквозная идентификация |
| order_id | Идентификатор заказа | Главный связыватель для поиска |
| user_id | ID пользователя | Быстрый поиск по жалобам |
| url_path | URL входящего запроса | Отслеживание маршрута |
| timestamp | Время события | Анализ задержек |
| event | order_submitted, price_calculated и т.д. | Бизнес-события |
| errors | Exception message, stack trace | Диагностика проблем |

## 2. Мотивация внедрения

### 2.1 Технические преимущества
- Уменьшение времени поиска проблем с часов до минут
- Полная картина взаимодействий в распределенной системе
- Выявление "затыков" и медленных операций
- Контекст для любых исключений и ошибок

### 2.2 Влияние на метрики
**Технические:**
- Скорость обработки запросов на стороне СУБД
- Нагрузка на промежуточные сервисы
- Количество внешних API запросов

**Бизнес-метрики:**
- Время исполнения заказа (полный цикл)
- Количество заказов выполненных/не выполненных в срок
- Время ожидания заказа до взятия в работу

## 3. Предлагаемое решение

### 3.1 Технологический стек
- **OpenTelemetry SDK** для инструментирования:
  - Java (Spring Boot) - через opentelemetry-javaagent
  - .NET (MES) - OpenTelemetry .NET SDK
- **Jaeger** для сбора и визуализации трейсов
- **Prometheus + Grafana** для технических метрик (уже есть из предыдущего решения)

### 3.2 Архитектура развертывания
- Для начала: Jaeger all-in-one в памяти
- При росте: кластер с отдельным storage backend (Elasticsearch/Kafka)

## 4. Компромиссы и ограничения

1. **MES API (C#)** - сторонний код, потребуется:
   - Обёртки над основными действиями (StartManufacturing, CalculatePrice)
   - Интеграция через middleware ASP.NET Core
   - Дополнительное время на изучение недокументированной логики

2. **Ресурсные ограничения**:
   - Нельзя трейсить всё и каждую миллисекунду
   - Возможно временное включение трейсинга на проблемных узлах
   - Требуются люди, знания, техника для анализа данных

3. **Интеграционные сложности**:
   - S3 и RabbitMQ - трудозатратная интеграция трейсинга
   - Не так много межсервисных взаимодействий для полной отдачи

## 5. Безопасность

### 5.1 Контроль доступа
- **Аутентификация**: интеграция с корпоративной системой (LDAP)
- **Авторизация**: только сотрудники с ролями "Поддержка" и "DevOps"
- **Сетевая изоляция**: 
  - Доступ через VPN или reverse proxy
  - Разделение по VLAN между магазином и внутренней системой
  - SSH ключи с ограничением по MAC-адресам для инфраструктуры

### 5.2 Разделение полномочий
- **Только чтение**: support, QA команды
- **Полный доступ**: только DevOps (удаление, конфигурации)
- **Аудит**: логирование всех действий пользователей

## 6. План внедрения

1. **Фаза 1**: Развертывание Jaeger all-in-one, инструментирование Shop API
2. **Фаза 2**: Добавление CRM API, настройка алертов на зависания
3. **Фаза 3**: Интеграция MES API (самая сложная часть)
4. **Фаза 4**: Опциональная интеграция RabbitMQ и S3 при необходимости

**Ожидаемый результат**: полная прозрачность прохождения заказа от создания до отгрузки с возможностью быстрой диагностики проблем.